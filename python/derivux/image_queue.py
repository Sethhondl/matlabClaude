"""
Image Queue - Thread-safe queue for passing images from MCP tools to the UI.

This bypasses the Claude SDK's response stream, ensuring images generated
by tools are delivered directly to the UI.
"""

import threading
from typing import Any, Dict, List, Optional


class ImageQueue:
    """Thread-safe queue for images generated by MCP tools."""

    _instance: Optional['ImageQueue'] = None
    _lock = threading.Lock()

    def __new__(cls) -> 'ImageQueue':
        """Singleton pattern to ensure one global queue."""
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
                    cls._instance._images: List[Dict[str, Any]] = []
                    cls._instance._queue_lock = threading.Lock()
        return cls._instance

    def push(self, image_data: Dict[str, Any]) -> None:
        """Add an image to the queue.

        Args:
            image_data: Dict with 'type', 'source' containing base64 image
        """
        with self._queue_lock:
            self._images.append(image_data)

    def poll(self) -> List[Dict[str, Any]]:
        """Get and clear all pending images.

        Returns:
            List of image dicts
        """
        with self._queue_lock:
            images = self._images.copy()
            self._images = []
            return images

    def clear(self) -> None:
        """Clear the queue."""
        with self._queue_lock:
            self._images = []


# Global instance for easy access
_queue = ImageQueue()


def push_image(image_data: Dict[str, Any]) -> None:
    """Push an image to the global queue."""
    _queue.push(image_data)


def poll_images() -> List[Dict[str, Any]]:
    """Poll images from the global queue."""
    return _queue.poll()


def clear_images() -> None:
    """Clear the global image queue."""
    _queue.clear()
